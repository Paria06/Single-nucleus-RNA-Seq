# Load libraries
library(metaRNASeq)
library(tidyverse)
library(patchwork)

base_path <- "/Users/paria/OneDrive/Rsession/analysis/"

directories <- c(med_cluster = "DEG/batch_regressed/medals_ocuals/cluster/",
                 med_main = "DEG/batch_regressed/medals_ocuals/main/",
                 sc_cluster =  "DEG/batch_regressed/scals_ocuals/cluster/",
                 sc_main = "DEG/batch_regressed/scals_ocuals/main/",
                 sl_cluster =  "DEG/batch_regressed/slals_ocuals/cluster/",
                 sl_main = "DEG/batch_regressed/slals_ocuals/main/")

types <- list(subtype = c("med_cluster", "sc_cluster", "sl_cluster"), main = c("med_main", "sc_main", "sl_main"))

pdf(file = paste0(base_path, "p_values_dist.pdf"), onefile = TRUE)
for(this_type_name in names(types)) {
  this_type <- types[[this_type_name]]
  # it could be significant pvalue or unfiltered pvalue
  med_data <-  read_csv(file = paste0(base_path, directories[[this_type[1]]], "1_raw_cluster.csv")) 
  sc_data <-  read_csv(file = paste0(base_path, directories[[this_type[2]]], "1_raw_cluster.csv")) 
  sl_data <-  read_csv(file = paste0(base_path, directories[[this_type[3]]], "1_raw_cluster.csv"))
  cell_clusters <- intersect(intersect(unique(med_data$cluster_id), unique(sc_data$cluster_id)), unique(sl_data$cluster_id))
  all_cluster_data <- list()
  all_cluster_data_unfiltered <- list()
  plots_list <- list()
  for(this_cluster in cell_clusters) {
    med_data_subset <- med_data %>% filter(cluster_id == this_cluster) %>%  
      select(gene, cluster_id, log2FoldChange, pvalue, padj)
    sc_data_subset <- sc_data %>% filter(cluster_id == this_cluster) %>%  
      select(gene, cluster_id, log2FoldChange, pvalue, padj)
    sl_data_subset <- sl_data %>% filter(cluster_id == this_cluster) %>%  
      select(gene, cluster_id, log2FoldChange, pvalue, padj) 
    subset_combined <- inner_join(med_data_subset, sc_data_subset, by = "gene", suffix = c(".med", ".sc")) 
    sl_data_subset <- sl_data_subset %>% rename_with(~ paste0(., ".sl"), -gene)
    #sl_data_subset <- sl_data_subset %>% rename_with(~ paste0(., ".sl"), everything())
    subset_combined <- inner_join(subset_combined, sl_data_subset, by = "gene") 
    subset_combined
    subset_combined %>% select(contains("pvalue")) -> ind_p_val
    ind_p_val <-list(med = ind_p_val$pvalue.med, sc = ind_p_val$pvalue.sc, sl = ind_p_val$pvalue.sl)
    fisher_comb_res <- fishercomb(ind_p_val, BHth = 0.05)
    all_cluster_data[[this_cluster]] <- bind_cols(subset_combined, fisher_comb_res[2:4]) %>% filter(adjpval < 0.05)
    all_cluster_data_unfiltered[[this_cluster]] <- bind_cols(subset_combined, fisher_comb_res[2:4]) 
    MASS::truehist(ind_p_val$med, xlab = paste("med p_values", this_cluster))
    MASS::truehist(ind_p_val$sc, xlab = paste("sc p_values", this_cluster))
    MASS::truehist(ind_p_val$sl, xlab = paste("sl p_values", this_cluster))
    
  }
  print(plots_list)	
  all_cluster_data <- bind_rows(all_cluster_data) %>% mutate(signs = sign(log2FoldChange.med)*sign(log2FoldChange.sc)*sign(log2FoldChange.sl))
  all_cluster_data_unfiltered <- bind_rows(all_cluster_data_unfiltered) %>% mutate(signs = sign(log2FoldChange.med)*sign(log2FoldChange.sc)*sign(log2FoldChange.sl))
  
  write.csv(all_cluster_data, file = paste0(base_path, "meta_analysis", "/1_combination_pvals_ocusl_", this_type_name, ".csv"))
  write.csv(all_cluster_data_unfiltered, file = paste0(base_path, "meta_analysis", "/2_combination_pvals_ocusl_unfiltered", this_type_name, ".csv"))	
}
dev.off()

print(summary(warnings()))
sessionInfo()

